/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2015 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

Use of this file is permitted only within the Momentum Google Chrome
extension as published on the Google Chrome Web Store at
https://chrome.google.com/webstore/detail/momentum/laookkfknpbbblfpciffpaejjkokdgca
*/
function momoInit(){return!0}function validateEmail(e){var t=/[^@]+@[^@]+\.[^@]+/;return t.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))}function getActiveDateString(){var e=new Date;return activeDateStringForDate(e)}function activeDateStringForDate(e){var t=new Date(e);t.getHours()<5&&(t=new Date(t.getTime()-864e5));var n=t.getFullYear().toString()+"-"+twoDigit(t.getMonth()+1)+"-"+twoDigit(t.getDate());return n}function twoDigit(e){var t=parseInt(e),n=t>=10?t:"0"+t.toString();return n.toString()}function submitStats(e){momoInit();var t={eventType:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootStats+"ingest"}).done(function(e){e&&e.download&&m.trigger("sync:download",e.download)}).fail(function(e,t){})}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveDateString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setMaxWidgetHeight(){var e=$(window).height()-125;return $(".pane").css("max-height",e),$(".todo-list").css("max-height",e-79),e}function setEndOfContenteditable(e){var t,n;document.createRange&&(t=document.createRange(),t.selectNodeContents(e),t.collapse(!1),n=window.getSelection(),n.removeAllRanges(),n.addRange(t))}window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},react:{mixins:{}},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[]},Backbone.Events),Backbone.View=function(e){return e.extend({constructor:function(t){this.options=t||{},e.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;Backbone.sync=function(e,t,n){n.beforeSend=function(e){setMomentumAuthHeader(e)},backboneSync(e,t,n)},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info-template"]=Handlebars.template({1:function(e,t,n,i){var o,s,a=t.helperMissing,l="function";return'    <span class="background-info-source">\n        <span class="background-info-source-link control" data-url="'+this.escapeExpression((s=null!=(s=t.sourceUrl||(null!=e?e.sourceUrl:e))?s:a,typeof s===l?s.call(e,{name:"sourceUrl",hash:{},data:i}):s))+'">'+(null!=(s=null!=(s=t.attribution||(null!=e?e.attribution:e))?s:a,o=typeof s===l?s.call(e,{name:"attribution",hash:{},data:i}):s)?o:"")+"</span>\n    </span>\n"},3:function(e,t,n,i){var o;return'    <span class="background-info-source">'+this.escapeExpression((o=null!=(o=t.attribution||(null!=e?e.attribution:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"attribution",hash:{},data:i}):o))+"</span>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s;return'<span class="background-info-title">'+(null!=(s=null!=(s=t.title||(null!=e?e.title:e))?s:t.helperMissing,o="function"==typeof s?s.call(e,{name:"title",hash:{},data:i}):s)?o:"")+'<i class="icon-angle-right"></i></span>\n'+(null!=(o=t["if"].call(e,null!=e?e.sourceUrl:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.program(3,i,0),data:i}))?o:"")},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock["centerclock-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return'<h1 class="time">'+this.escapeExpression((o=null!=(o=t.time||(null!=e?e.time:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"time",hash:{},data:i}):o))+'</h1>\n<span class="format">AM</span>'},useData:!0}),m.templates=m.templates||{},m.templates.focus=m.templates.focus||{},m.templates.focus["focus-prompt-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<h3>What is your main focus for today?</h3>\n<input type="text">'},useData:!0}),m.templates.focus["focus-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return"<h3>"+l((o=null!=(o=t.day||(null!=e?e.day:e))?o:s,typeof o===a?o.call(e,{name:"day",hash:{},data:i}):o))+'</h3>\n<span class="control checkbox"><i class="icon icon-checkbox-empty focus-open"></i><i class="icon icon-checkbox focus-done"></i></span><p class="todays-focus">'+l((o=null!=(o=t.focus||(null!=e?e.focus:e))?o:s,typeof o===a?o.call(e,{name:"focus",hash:{},data:i}):o))+'</p><span class="control delete"><i>✕</i></span>\n'},useData:!0}),m.templates.focus["focuses-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<ol></ol>\n<div class="message">\n    <i class="loading-icon"></i>Loading...</span>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h2>Good <span class="period">'+l((o=null!=(o=t.period||(null!=e?e.period:e))?o:s,typeof o===a?o.call(e,{name:"period",hash:{},data:i}):o))+'</span>, <span class="name" spellcheck="false">'+l((o=null!=(o=t.name||(null!=e?e.name:e))?o:s,typeof o===a?o.call(e,{name:"name",hash:{},data:i}):o))+"</span>.</h2>"},useData:!0}),m.templates=m.templates||{},m.templates.introduction=m.templates.introduction||{},m.templates.introduction["introduction-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return'<button class="button">'+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:i}):o))+"</button>"},useData:!0}),m.templates.introduction["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return'<div class="prompt">\n    '+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:i}):o))+'\n    <input id="introduction-input" type="text">\n    <div class="tip"></div>\n</div>\n<div class="buttons"></div>'},useData:!0}),m.templates.introduction["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<p class="logo"><img src="img/logo-white.png"></p>\n<p class=content></p>'},useData:!0}),m.templates.introduction["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return"<div>"+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:i}):o))+"</div>"},useData:!0}),m.templates=m.templates||{},m.templates.message=m.templates.message||{},m.templates.message["message-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=t.helperMissing,l="function";return"<h4>"+(null!=(s=null!=(s=t.title||(null!=e?e.title:e))?s:a,o=typeof s===l?s.call(e,{name:"title",hash:{},data:i}):s)?o:"")+'</h4>\n<p>\n    <span class="message">'+(null!=(s=null!=(s=t.message||(null!=e?e.message:e))?s:a,o=typeof s===l?s.call(e,{name:"message",hash:{},data:i}):s)?o:"")+'</span>\n</p>\n<a href="" class="hide"><span>✕</span></a>'},useData:!0}),m.templates.message["notification-message-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=t.helperMissing,l="function";return'<div class="pane widget-pop widget-pop-up message-pop">\n    <header class="pop-header">\n                        <span class="heading">\n                            <i class="logo icon-disconnected"></i>'+(null!=(s=null!=(s=t.title||(null!=e?e.title:e))?s:a,o=typeof s===l?s.call(e,{name:"title",hash:{},data:i}):s)?o:"")+'\n                        </span>\n    </header>\n    <div class="popup-body">\n        <p>'+(null!=(s=null!=(s=t.message||(null!=e?e.message:e))?s:a,o=typeof s===l?s.call(e,{name:"message",hash:{},data:i}):s)?o:"")+'</p>\n        <a href="" class="cta button">Ok</a>\n    </div>\n</div>'},useData:!0}),m.templates=m.templates||{},m.templates.quicklinks=m.templates.quicklinks||{},m.templates.quicklinks["quicklinks-item-template"]=Handlebars.template({1:function(e,t,n,i){return' class="local"'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div draggable="true" class="view '+r((s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a,typeof s===l?s.call(e,{name:"classes",hash:{},data:i}):s))+'">\n    <a draggable="false" href="'+r((s=null!=(s=t.url||(null!=e?e.url:e))?s:a,typeof s===l?s.call(e,{name:"url",hash:{},data:i}):s))+'"'+(null!=(o=t["if"].call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")+'><img src="'+r((s=null!=(s=t.favicon_url||(null!=e?e.favicon_url:e))?s:a,typeof s===l?s.call(e,{name:"favicon_url",hash:{},data:i}):s))+'"> '+r((s=null!=(s=t.title||(null!=e?e.title:e))?s:a,typeof s===l?s.call(e,{name:"title",hash:{},data:i}):s))+'</a>\n    <span draggable="false" class="control destroy">✕</span>\n</div>\n'},useData:!0}),m.templates.quicklinks["quicklinks-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<div class="pane quicklinks-pane light">\n    <ol>\n        <li><a href="chrome-search://local-ntp/local-ntp.html" class="local"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNUExQ0NERUQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNUExQ0NERkQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjM1QTFDQ0RDRDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjM1QTFDQ0RERDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+9GSZXwAAAItJREFUeNrslLEOgCAMRKkOfrmDiT8MamoxlElxKmW4JhdCbuBI+o6YOXjOFJwHARBgiACrKIq4o2J5N5D0wCnn7PD5JFpyAM8moiF24HJ6O2mATS8d5xDtuoTogbceqJxa+60eeDgVmfp/PUAlsZnfwlDJMPW/MKyYWPtDYAgKQAEoQAAEcJ1bgAEAiqqzy70omloAAAAASUVORK5CYII=" class="icon-chrome-tab" > Chrome Tab</a></li>\n        <li><a href="chrome://apps" id="app-return" class="local"><i class="icon icon-th"></i> Apps</a></li>\n    </ol>\n    <div class="connection-message"><i class="loading-icon"></i>Loading...</div>\n    <div class="error-message">Connection required to add link</div>\n    <a href="" class="control add">+</a>\n    <ul class="message">\n        <li class="empty">\n            <span class="">Add your favorite links</span>\n            <span class="description">Use the <strong><span class="icon">+</span> button</strong> above</span>\n            <a href="" class="hide">✕</a>\n        </li>\n    </ul>\n    <div class="quicklinks-new">\n        <input id="quicklinks-new-title" class="title-input" type="text" placeholder="Title">\n        <input id="quicklinks-new-url" class="address-input" type="text" placeholder="Address">\n    </div>\n</div>\n<a class="quicklinks-show top-nav toggle" href="">Links</a>\n'},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote["shortquote-template"]=Handlebars.template({1:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<p class="light source">'+l((o=null!=(o=t.source||(null!=e?e.source:e))?o:s,typeof o===a?o.call(e,{name:"source",hash:{},data:i}):o))+'<span data-url="'+l((o=null!=(o=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?o:s,typeof o===a?o.call(e,{name:"twitterIntentUrl",hash:{},data:i}):o))+'" class="control share-twitter"><i class="icon-twitter"></i></span></p>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s;return'<p class="light body">&ldquo;'+this.escapeExpression((s=null!=(s=t.body||(null!=e?e.body:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"body",hash:{},data:i}):s))+'&rdquo;<i class="icon-angle-right"></i></p>\n'+(null!=(o=t["if"].call(e,null!=e?e.source:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")},useData:!0}),m.templates=m.templates||{},m.templates.settings=m.templates.settings||{},m.templates.settings.about=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return'<div class="pop-body settings-about">\n	<p class="logo"><img src="img/logo-white.png"></p>\n	<h3>Momentum</h3>\n	<p class="made">Personal Dashboard <span class="quiet" id="momo-version">v'+this.escapeExpression((o=null!=(o=t.version||(null!=e?e.version:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"version",hash:{},data:i}):o))+'</span></p>\n	<p class="thanks">Thank you for your support!</p>\n	<p class="links">\n		<a href="http://momentumdash.com/help" target="_blank">Feedback</a>\n		<a href="http://momentumdash.com/blog" target="_blank">Blog</a>\n		<a href="https://www.facebook.com/momentumdash" target="_blank">Facebook</a>\n		<a href="https://twitter.com/momentumdash" target="_blank">Twitter</a></p>\n	<p class="footer">\n		<a href="http://momentumdash.com" target="_blank">momentumdash.com</a> &nbsp;&nbsp; Made with &#9829; in BC, Canada\n	</p>\n</div>'},useData:!0}),m.templates.settings["general-toggle-options"]=Handlebars.template({1:function(e,t,n,i,o,s){var a;return null!=(a=t.unless.call(e,i&&i.last,{name:"unless",hash:{},fn:this.program(2,i,0,o,s),inverse:this.program(4,i,0,o,s),data:i}))?a:""},2:function(e,t,n,i,o,s){var a,l=this.lambda,r=this.escapeExpression,c=t.helperMissing,d="function";return'				<span class="toggle-option '+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+r((a=null!=(a=t.value||(null!=e?e.value:e))?a:c,typeof a===d?a.call(e,{name:"value",hash:{},data:i}):a))+">"+r((a=null!=(a=t.label||(null!=e?e.label:e))?a:c,typeof a===d?a.call(e,{name:"label",hash:{},data:i}):a))+'</span>\n				<span class="divider">|</span>\n'},4:function(e,t,n,i,o,s){var a,l=this.lambda,r=this.escapeExpression,c=t.helperMissing,d="function";return'				<span class="toggle-option '+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+r((a=null!=(a=t.value||(null!=e?e.value:e))?a:c,typeof a===d?a.call(e,{name:"value",hash:{},data:i}):a))+">"+r((a=null!=(a=t.label||(null!=e?e.label:e))?a:c,typeof a===d?a.call(e,{name:"label",hash:{},data:i}):a))+"</span>\n"},6:function(e,t,n,i){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:i}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i,o,s){var a,l;return'<li class="slide-toggle">\n	'+this.escapeExpression((l=null!=(l=t.name||(null!=e?e.name:e))?l:t.helperMissing,"function"==typeof l?l.call(e,{name:"name",hash:{},data:i}):l))+'\n	<span class="toggle-options">\n'+(null!=(a=t.each.call(e,null!=e?e.options:e,{name:"each",hash:{},fn:this.program(1,i,0,o,s),inverse:this.noop,data:i}))?a:"")+"	</span>\n    "+(null!=(a=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(6,i,0,o,s),inverse:this.noop,data:i}))?a:"")+"\n</li>"},useData:!0,useDepths:!0}),m.templates.settings["general-toggle-slider"]=Handlebars.template({1:function(e,t,n,i){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:i}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+r((s=null!=(s=t.widget||(null!=e?e.widget:e))?s:a,typeof s===l?s.call(e,{name:"widget",hash:{},data:i}):s))+'">\n    <input type="checkbox"></input>\n    <span>'+r((s=null!=(s=t.name||(null!=e?e.name:e))?s:a,typeof s===l?s.call(e,{name:"name",hash:{},data:i}):s))+'</span>\n    <span class="toggle-slider"><span class="toggle-switch"></span></span>\n    '+(null!=(o=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")+"\n</li>"},useData:!0}),m.templates.settings.general=Handlebars.template({1:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <div class="user">\n            <span class="action action-logout">Logout</span>\n            <div class="user-gravatar">\n                <img src="">\n            </div>\n            <span class="name">'+l((o=null!=(o=t.displayname||(null!=e?e.displayname:e))?o:s,typeof o===a?o.call(e,{name:"displayname",hash:{},data:i}):o))+'</span><br>\n            <span class="email">'+l((o=null!=(o=t.email||(null!=e?e.email:e))?o:s,typeof o===a?o.call(e,{name:"email",hash:{},data:i}):o))+"</span>\n        </div>\n"},3:function(e,t,n,i){return'        <div class="user login">\n            <span class="name">Login</span>\n            <span class="action">Sync account and more!</span>\n        </div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=this.lambda,l=this.escapeExpression;return'<div class="pop-body">\n'+(null!=(o=t["if"].call(e,null!=e?e.loggedIn:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.program(3,i,0),data:i}))?o:"")+'\n    <h4>Account Sync</h4>\n    <p class="description">'+l(a(null!=(o=null!=e?e.sync:e)?o.description:o,e))+'</p>\n    <ul class="options-list">\n        <li class="slide-toggle sync-option">\n            <input class="sync-check" type="checkbox"></input>\n            <span class="sync-caption">'+l(a(null!=(o=null!=e?e.sync:e)?o.name:o,e))+'</span>\n            <span class="toggle-slider"><span class="toggle-switch"></span></span>\n            <span class="option-message">'+l(a(null!=(o=null!=e?e.sync:e)?o.message:o,e))+'</span>\n        </li>\n    </ul>\n\n    <h4>Customize</h4>\n    <p class="description">'+l((s=null!=(s=t.description||(null!=e?e.description:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"description",hash:{},data:i}):s))+'</p>\n\n    <ul id="customize-list" class="options-list"></ul>\n\n    <h5>Tip</h5>\n    <p class="no-top-margin">Many items in Momentum can be edited by double clicking on them, including: <strong>your name</strong>, <strong>location</strong>, <strong>clock</strong>, <strong>temperature</strong>, and <strong>todos</strong>.\n    </p>\n</div>'},useData:!0}),m.templates.settings.help=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<div class="pop-body settings-help">\n	<h3>Help</h3>\n	<p class="description"></p>\n\n	<h5>Tips</h5>\n	<p>To change your name, toggle the temperature between C and F, change your location, or toggle the clock between 12 and 24 hour, <strong>double click</strong> on the setting you wish to change.</p>\n\n	<h5>Hotkeys</h5>\n	<p class="hotkeys">\n		<span class="col">\n			<strong>T</strong> - Todo<br>\n			<strong>F</strong> - Focus<br>\n			<strong>,</strong> - Settings<br>\n			<strong>ESC</strong> - Cancel, close\n		</span><span class="col">\n			<strong>L</strong> - Links<br>\n			<strong>S</strong> - Search<br>\n			<strong>C</strong> - Chrome Tab<br>\n		</span>\n	</p>\n	<p>\n		Press <strong>TAB</strong> twice when opening a new tab to be able to use hotkeys\n	</p>\n\n	<h5>Need more help?</h5>\n	<p>\n		Check out our Help Center<br>\n		<a href="http://momentumdash.com/help" class="button button-inline" target="_blank">Go to Help Center</a>\n	</p>\n</div>'},useData:!0}),m.templates.settings.main=Handlebars.template({1:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'            <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:i}):o))+'" class="main-nav-item">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:i}):o))+"</li>\n"},3:function(e,t,n,i){var o;return null!=(o=t["if"].call(e,i&&i.first,{name:"if",hash:{},fn:this.program(4,i,0),inverse:this.program(6,i,0),data:i}))?o:""},4:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'                <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:i}):o))+'" class="main-nav-item secondary secondary-first">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:i}):o))+"</li>\n"},6:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'                <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:i}):o))+'" class="main-nav-item secondary">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:i}):o))+"</li>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return'<div class="pane widget-pop settings">\n    <!--\n    <i class="hide">✕</i>\n    <header class="pop-header">\n		<span class="pop-title">\n			Settings\n		</span>\n        <nav class="pop-nav pop-nav-right">\n            <i class="action hide">✕</i>\n        </nav>\n        <p class="description">Choose a service</p>\n    </header>\n    -->\n    <ul class="main-nav">\n'+(null!=(o=t.each.call(e,null!=e?e.navItems:e,{name:"each",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")+(null!=(o=t.each.call(e,null!=e?e.secondaryNavItems:e,{name:"each",hash:{},fn:this.program(3,i,0),inverse:this.noop,data:i}))?o:"")+'    </ul>\n    <div class="subpanel-container"></div>\n</div>'},useData:!0}),m.templates=m.templates||{},m.templates.todos=m.templates.todos||{},m.templates.todos["todo-complete-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="metric-stat">'+l((o=null!=(o=t.done||(null!=e?e.done:e))?o:s,typeof o===a?o.call(e,{name:"done",hash:{},data:i}):o))+'</span>\n<span class="metric-label">'+l((o=null!=(o=t.item||(null!=e?e.item:e))?o:s,typeof o===a?o.call(e,{name:"item",hash:{},data:i}):o))+" complete</span>"},useData:!0}),m.templates.todos["todo-item-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n    <i class="control destroy">✕</i>\n    <i class="loading-icon"></i>\n    <i class="control error-icon">!</i>\n    <label><input class="toggle" type="checkbox" '+l((o=null!=(o=t.checked||(null!=e?e.checked:e))?o:s,typeof o===a?o.call(e,{name:"checked",hash:{},data:i}):o))+"></label><span>"+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:i}):o))+'</span>\n</div>\n<input class="edit todo-input" type="text" value="'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:i}):o))+'">'},useData:!0}),m.templates.todos["todo-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<div class="pane todo-pane">\n    <div class="todo-header">\n        <ul>\n            <li><span class="todo-count"><i class="loading-icon"></i>Loading...</span></li>\n        </ul>\n        <div class="error-message">Connection required to add Todo</div>\n    </div>\n    <div class="empty empty-todo">\n        <div class="content">\n            <div class="graphic">☺</div>\n            <div class="title">Nothing to do</div>\n            <div class="description">One step at a time...</div>\n        </div>\n        <div class="action"><a href="" class="show-completed">Completed today</a></div>\n    </div>\n    <ol class="todo-list"></ol>\n    <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New todo">\n</div>\n<span id="todo-remaining"></span>\n<span class="toggle todo-toggle medium">Todo</span>'},useData:!0}),m.templates=m.templates||{},m.templates.weather=m.templates.weather||{},m.templates.weather["weather-template"]=Handlebars.template({1:function(e,t,n,i){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <span class="icon" data-icon="'+l((o=null!=(o=t.code||(null!=e?e.code:e))?o:s,typeof o===a?o.call(e,{name:"code",hash:{},data:i}):o))+'" title="'+l((o=null!=(o=t.condition||(null!=e?e.condition:e))?o:s,typeof o===a?o.call(e,{name:"condition",hash:{},data:i}):o))+'"></span>'+l((o=null!=(o=t.temperature||(null!=e?e.temperature:e))?o:s,typeof o===a?o.call(e,{name:"temperature",hash:{},data:i}):o))+'&deg;<span class="unit '+l((o=null!=(o=t.unitClass||(null!=e?e.unitClass:e))?o:s,typeof o===a?o.call(e,{name:"unitClass",hash:{},data:i}):o))+'">'+l((o=null!=(o=t.unit||(null!=e?e.unit:e))?o:s,typeof o===a?o.call(e,{name:"unit",hash:{},data:i}):o))+"</span>\n"},3:function(e,t,n,i){return"        N/A\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div class="metric-stat">\n'+(null!=(o=t["if"].call(e,null!=e?e.temperature:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.program(3,i,0),data:i}))?o:"")+'</div>\n<span class="location metric-label data">'+r((s=null!=(s=t.location||(null!=e?e.location:e))?s:a,typeof s===l?s.call(e,{name:"location",hash:{},data:i}):s))+'</span>\n<span class="metric-message">'+r((s=null!=(s=t.message||(null!=e?e.message:e))?s:a,typeof s===l?s.call(e,{name:"message",hash:{},data:i}):s))+"</span>"},useData:!0}),m.globals.version="0.70.0",m.globals.platform="chrome",m.globals.googleAnalyticsCode="UA-44319322-1",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){this.addinCollection=new m.collect.AddinCollection,this.loadFromAddinObject()},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var t=this;_.each(m.addins,function(e,n){var i=t.addinCollection.findWhere({id:n});i||t.loadEvaluatedAddin(n,e)}),e&&this.processPending()},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1}),function(e){try{var t=e.get("addInCode");t&&(t(m,$),e.set({processed:!0}))}catch(n){console.log(n)}})},evaluatePending:function(){_.each(this.addinCollection.where({evaluated:!1}),function(addin){try{var rawCode=addin.get("rawCode");if(rawCode){var addIn=eval(rawCode);addin.set({evaluated:!0,addInCode:addIn})}}catch(e){console.log(e)}})}}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=Backbone.Collection.extend({model:m.models.Command,initialize:function(){var e=this;m.commands&&_.mapObject(m.commands,function(t){e.registerCommandModel(t,!1)})},registerCommandModel:function(e,t){var n=new e;if(n&&n.id&&(t||!this.get(n.id))){var i=this.get(n.id);i&&this.remove(i),this.add(n)}},registerCommand:function(e,t,n,i){var o={defaults:{id:e},execute:t};n&&(o.canExecute=n);var s=m.models.Command.extend(o);this.registerCommandModel(s,i)},getCommand:function(e){return e?this.get(e):null},execute:function(e){var t=this.getCommand(e);return t?t.execute.apply(t,[].slice.call(arguments,1)):void 0},canExecute:function(e){var t=this.getCommand(e);return t?t.canExecute.apply(t,[].slice.call(arguments,1)):!0}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){try{if(!localStorage.client_uuid)return;var t=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var n=[];e.indexOf("quote")>-1&&(n[n.length]="quote"),e.indexOf("background")>-1&&(n[n.length]="background"),t+=n.length>0?n.join(","):"all"}else t+="all";if(t=t+"&localDate="+getActiveDateString(),!localStorage.firstSynchronized){var i=m.models.activeBackground.activeBackgroundUuid();if(!i){var o=m.collect.legacyBackgrounds.getCurrentLocalBackground();o&&(i=o.backgroundUuid())}i&&(t=t+"&legacyBackground="+i)}var s=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:t}).done(function(e){e.quotes&&e.quotes.length>0&&(m.collect.shortquotes.reset(e.quotes),m.collect.shortquotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote"),localStorage.setItem(s.ddlQuoteString(),Date.now())),e.backgrounds&&e.backgrounds.length>0&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),localStorage.setItem(s.ddlBackgroundString(),Date.now())),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,t){})}catch(a){}},doDownloadIfNeeded:function(){localStorage[this.ddlBackgroundString()]?localStorage[this.ddlQuoteString()]||this.doDownload("quote"):localStorage[this.ddlQuoteString()]?this.doDownload("background"):this.doDownload()},pingApi:function(e,t){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(t){e&&e()}).fail(function(e,n){t&&t()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){
if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,n){var i={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){n&&n()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e&&(e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features),e.customization&&m.models.customization.save(e.customization),e.lists&&e.lists.length>0&&m.models.todoListManager&&m.models.todoListManager.mergeLists(e.lists),e.addIns)){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.addIns.length;i++){var t=e.addIns[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}).fail(function(e,t){}).always(function(){t.syncSettingsInProgress=!1}).always(function(){e&&e()})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(){try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(e){this.featureList=[]}},featureEnabled:function(e){return _.contains(this.featureList,e)},setFeatures:function(e){localStorage.f3t6b23d!==e&&(localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),m.trigger("feature:changed"))},checkFeatureAndMigrateData:function(e,t,n,i,o,s){var a=null;if(this.featureEnabled(e)){for(var l=!1,r=0;r<localStorage.length;r++)if(keyName=localStorage.key(r),0===keyName.indexOf(n+"-")){var l=!0;break}if(l)try{for(var c=new Date,d=c.getFullYear().toString()+"-"+twoDigit(c.getMonth()+1)+"-"+twoDigit(c.getDate())+"-"+twoDigit(c.getHours())+":"+twoDigit(c.getMinutes())+":"+twoDigit(c.getSeconds()),u="migrated-"+n+"-"+d,h=[],g=[],r=0;r<localStorage.length;r++)if(keyName=localStorage.key(r),0===keyName.indexOf(n+"-")){g.push(keyName);var p=localStorage.getItem(keyName);if(p){var f=JSON.parse(p);h.push(f)}}var v={items:h},w=JSON.stringify(v);$.ajax({type:"POST",contentType:"application/json",data:w,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+n}).done(function(e,o,s){localStorage.setItem(u,w);for(var a in g)localStorage.removeItem(g[a]);localStorage.removeItem(n),m.trigger("sync:customization"),(!t||m.models.customization.get(t))&&i()}).fail(function(e,n){(!t||m.models.customization.get(t))&&o()})}catch(k){console.log(k)}else a=i}else a=o;a&&(!t||m.models.customization.get(t)?a():s&&s(a))},checkPreferenceForRender:function(e,t,n){t&&(!e||m.models.customization.get(e)?t():n&&n(t))}}),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t=this.get("filename");if(0===t.indexOf("http"))return null;var n=t.split("/");if(2==n.length){var n=n[1].split(".");if(2==n.length)return n[0]}return null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.backgrounds.length>0&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var e=this.fallbackKey(),t=localStorage.getItem(e),n=null;t&&(n=this.legacyBackgrounds.get(t)),n||(n=this.legacyBackgrounds.getCurrentLocalBackground(),n&&localStorage.setItem(e,n.backgroundUuid())),n&&(this.usingFallback=!0,this.setActiveBackground(n))},collectionReady:function(){this.usingFallback||this.checkActiveBackground()},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){if(this.backgrounds.length>0){var e=this.backgrounds.get(getActiveDateString());e||this.checkActiveBackground()}else this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;return this.backgrounds&&this.backgrounds.length>0&&(e=this.backgrounds.getActiveBackground())?void this.setActiveBackground(e):void this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem),this.preCacheFutureBackgroundImages()},setActiveBackground:function(e){e&&(this.backgroundItem&&this.backgroundItem.backgroundUuid()==e.backgroundUuid()||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e)))},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)});return t},preCacheFutureBackgroundImages:function(){var e=this,t=Date.parse(getActiveDateString());this.backgrounds&&this.backgrounds.length>0&&this.backgrounds.map(function(n){var i=Date.parse(n.get("forDate"));i>t&&e.preCacheBackgroundImage(n)})},preCacheBackgroundImage:function(e){if(e){var t=e.get("filename");if(t&&0===t.indexOf("http"))try{var n=new Image;n.addEventListener("load",function(e){n.removeEventListener("load",arguments.callee,!1)},!1),n.src=t}catch(i){}}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t=e.id;if(!t){var n=e.filename,i=n.split("/");if(2==i.length){var i=i[1].split(".");2==i.length&&(t=i[0])}}this.set({id:t,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(e){return filtered=this.filter(function(t){return t.get("fallbackDate")<e}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),n=localStorage.getItem(t);if(n&&(e=this.get(n)),!e){if(!this.parseRecentFallbacks())return null;var i=Math.floor(.75*this.models.length),o=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),s=_.first(o,i),a=_.map(s,function(e){return e.get("backgroundGuid")}),l=this.pluck("id");if(m.collect.backgrounds){var r=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});i=Math.floor(.25*this.models.length);var c=_.first(r,i),d=_.map(c,function(e){return e.get("_id")});a=_.union(a,d)}var u=_.difference(l,a);if(u.length>0){var h=_.sample(u);e=this.get(h)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var e=this;return $.each(localStorage,function(t,n){if(0===t.indexOf("fallback-")){var i=t.slice(9),o=Date.parse(i),s=new Backbone.Model({fallbackDate:o,backgroundGuid:n});e.fallbacks.add(s)}}),!0}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},events:{click:"closeTrays"},isBackgroundLoaded:!1,initialize:function(){this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(e){var t=this,n=e.get("filename"),i=e.backgroundUuid(),o=(e.get("title"),e.get("source"),e.get("sourceUrl"),(this.options.order||"append")+"To");$("#background").css("background-image",$("#background").find("li").css("background-image")),this.lastId=i,this.loadCompleted=!1,$("<img/>").on("load",function(){t.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(i),t.isBackgroundLoaded=!0,t.trigger("background:loadSuccessful"),i===t.lastId&&(t.$el[o]("#"+t.options.region).css("background-image","url("+n+")").addClass("fadein"),$(this).remove(),$(".widgets").addClass("fadein"),$(".background-overlay").addClass("fadein"))}).on("error",function(e){t.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback")}).attr("src",n),window.setTimeout(function(){t.loadCompleted||(t.loadCompleted=!0,console.log("image fallback via timer"),m.models.activeBackground.trigger("background:fallback"))},4e3)},closeTrays:function(e){$(".show").each(function(){removeClass("show")})}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{id:"background-info","class":"background-info light"},template:m.templates.background["background-info-template"],events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff",click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-source-link":"clickSource","click .source-url":"trackClick"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(e){var t="",n=null,i="",o="",s="";this.activeBackground=e,e&&(t=e.get("title"),o=e.get("sourceUrl"),s=e.get("detail_url"),n=e.get("attribution"),i=e.get("source"),n||(n="Photo by "+i)),t||this.$el.addClass("title-unknown"),i||this.$el.addClass("source-unknown"),s&&s.length>0?(this.detail_url=s,this.$el.addClass("has-link")):this.detail_url=null;var a={title:t,source:i,sourceUrl:o,attribution:n},l=(this.options.order||"append")+"To";return this.$el[l]("#"+this.options.region).fadeTo(0,0).html(this.template(a)).fadeTo(500,1),this},handleHoverOn:function(){var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":1})},300)},handleHoverOff:function(){var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":2})},300)},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},clickSource:function(e){e.preventDefault(),e.stopPropagation(),window.open($(e.currentTarget).data("url"),"_blank")},trackClick:function(){ga("send","event","BackgroundInfo","Click",localStorage.background)}}),m.views.Search=Backbone.View.extend({id:"search",className:"search top-widget",events:{"focusin .search-input":"handleFocusIn","focusout .search-input":"handleFocusOut","keyup .search-input":"checkForEscape","submit .form":"doSearch"},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"globalEvent:click",this.hideResults),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleSearch",this.toggleShow),this.listenTo(m.models.customization,"change:searchVisible",this.visibleChanged),this.render()},render:function(){var e='<form class="form"><span class="search-underline"></span><i class="icon-search"></i><input type="text" id="search-input" class="search-input" autocomplete="off"></form><iframe src="" class="search-results"></iframe>',t=(this.options.order||"append")+"To";return this.$el[t]("#"+this.options.region).fadeTo(0,0).html($.trim(e)).fadeTo(500,1),this.$input=this.$el.find("input"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("searchVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doSearch:function(e){e.preventDefault();var t=this.$el.find(".search-input")[0].value;if(t.length>0){var n=m.globals.urlRootApi+"search";if(!localStorage.token){var i=m.models.customization.get("searchProvider");i||(i="google"),n=n+"?provider="+i}$.ajax({type:"GET",beforeSend:m.utils.setMomentumAuthHeader,url:n}).done(function(e,n,i){if(e&&e.searchUrl){var o=e.searchUrl+encodeURIComponent(t);e.searchOutput&&"redirect"==e.searchOutput?window.location.href=o:$(".search-results").attr("src",o).attr("target","_top").addClass("fadein").css("display","block")}}).fail(function(e,n){var i="https://search.momentumdash.com/?q="+encodeURIComponent(t);$(".search-results").attr("src",i).attr("target","_top").addClass("fadein").css("display","block")}),ga("send","event","Search","Searched")}},handleFocusIn:function(){$(".search").addClass("active"),ga("send","event","Search","Focused")},handleFocusOut:function(){$(".search").removeClass("active")},hideResults:function(e){(!$.contains(this.el,e.target)&&$(".search-results").hasClass("fadein")||1==e.hide)&&$(".search-results").removeClass("fadein").css("display","none")},checkForEscape:function(e){27==e.keyCode&&this.hideResults({hide:"true"})},toggleShow:function(e){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.bootstrappers.RenderSearch=function(e,t){e.conditionalFeatures.checkPreferenceForRender("searchVisible",function(){e.views.search=new e.views.Search({region:"top-left",order:"append"}),e.widgets.push(e.views.search)},function(t){e.listenToOnce(e.models.customization,"change:searchVisible",t)})},m.models.GenericWidget=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var e=this,t="";this.set("label",t);var n=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:n}).done(function(t,n,i){if(t.metricInfo)e.set("id",t.metricInfo.metricId),e.set("value",t.metricInfo.metricValue),e.set("label",t.metricInfo.metricLabel),t.metricInfo.metricLink?e.set("link",t.metricInfo.metricLink):e.set("link",null);else if(t.status&&"authRequired"==t.status&&t.authorizationUrl&&e.authAttempts<2){e.authAttempts++;var o=t.winWidth?t.winWidth:600,s=t.winHeight?t.winHeight:510,a=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",l=window.screen.width/2-o/2,r=window.screen.height/2-s/2,c=window.open(t.authorizationUrl,"MomentumAuthWindow",a+",left="+l+",top="+r+",width="+o+",height="+s),d=setInterval(function(){c.closed&&(clearInterval(d),e.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(i){}},clickMetric:function(){this.get("link")}}),m.views.GenericWidget=Backbone.View.extend({attributes:{id:"generic-stats","class":"metric"},template:Handlebars.compile('<div><span class="metric-stat">{{statvalue}}</span></div><span class="metric-label">{{statlabel}}</span>'),events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var n={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(n)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var i=(this.options.order||"append")+"To";this.$el[i]("#"+this.options.region).fadeTo(0,0).html(this.template(n)).fadeTo(500,1),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.models.ShortQuote=Backbone.Model.extend({idAttribute:"forDate"}),m.collect.ShortQuotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.ShortQuote,getActiveQuote:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.views.ShortQuote=Backbone.View.extend({tagName:"blockquote",attributes:{id:"shortquote"},template:m.templates.quote["shortquote-template"],events:{click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .share-twitter":"shareTwitter"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1,this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.collection.length>0&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render()},visibleChanged:function(e){var t=m.models.customization.get("quoteVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},render:function(e){if(0===this.collection.length)return void m.trigger("sync:downloadIfNeeded");var t=this.collection.getActiveQuote();if(!t)return void m.trigger("sync:downloadIfNeeded");if(!this.currentlyActiveQuote||this.currentlyActiveQuote.get("_id")!=t.get("_id")){this.currentlyActiveQuote=t;var n=this,i=t.get("body"),o=t.get("source"),s=t.get("detail_url"),a=t.get("twitter"),l=t.get("twitterIntentUrl");if(!l){var r="";r=a?'"'+i+'" —@'+a:'"'+i+'" —'+o,l="https://twitter.com/intent/tweet?text="+encodeURIComponent(r)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}var c={body:i,source:o,twitterIntentUrl:l},d=(this.options.order||"append")+"To";e?n.$el[d]("#"+n.options.region).html(n.template(c)).fadeTo(500,1):n.$el[d]("#"+n.options.region).fadeTo(0,0).html(n.template(c)).fadeTo(500,1),s&&s.length>0?(this.detail_url=s,this.$el.addClass("has-link")):this.detail_url=null,this.renderedOnce=!0}},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.preventDefault(),e.stopPropagation();var t=screen.width/2-272.5,n=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+n+",width=545,height=420,resizeable=0")}}),m.bootstrappers.InitializeQuote=function(e,t){e.collect.shortquotes=new e.collect.ShortQuotes},m.bootstrappers.RenderQuote=function(e,t,n){e.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){e.views.shortQuote=new e.views.ShortQuote({collection:e.collect.shortquotes,model:e.models.date,region:"bottom"}),e.collect.shortquotes.fetch({reset:!0}),e.views.shortQuote.parentReady(n),e.widgets.push(e.views.shortQuote)},function(t){e.listenToOnce(e.models.customization,"change:quoteVisible",t)})},m.models.Focus=Backbone.Model.extend({defaults:{focus:"",day:"",forDate:null,archived:!1,createdDate:new Date,archivedDate:null,completed:!1,completedDate:null,cached:!1},saveOptions:function(){return this.collection.saveOptions},archive:function(){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())},toggleCompleted:function(){this.save({completed:!this.get("completed"),completedDate:this.get("completed")?null:new Date},this.saveOptions())}}),m.collect.FocusesBase=Backbone.Collection.extend({model:m.models.Focus,saveOptions:{},attributes:{},initialize:function(){this.loadingFromServer=!0,this.on("reset",this.onReset,this),this.on("add",this.onAdd,this),this.on("change",this.onModelChanged,this)},onReset:function(){this.loadingFromServer=!1,this.trigger("loadingFromServerChanged")},onModelChanged:function(e){var t=e.changedAttributes(),n=_.keys(t),i=_.without(n,"archived","archivedDate");i.length>0&&this.saveCachedFocus(e)},comparator:function(e){var t=e.get("createdDate");return t?-Date.parse(t):0},activeFocus:function(){if(this.loadingFromServer)return this.cachedFocus();if(0===this.length)return localStorage.removeItem("cachedFocus"),null;var e=null,t=getActiveDateString(),n=this.where({completed:!1,archived:!1,forDate:t});if(1===n.length)e=n[0];else if(0===n.length)if(n=this.where({completed:!0,archived:!1,forDate:t}),1===n.length)e=n[0];else if(0===n.length)return localStorage.removeItem("cachedFocus"),null;return null==e&&_.each(n,function(t){if(null==e)e=t;else{var n=t.get("createdDate"),i=e.get("createdDate");n>i&&(e=t)}}),e?this.saveCachedFocus(e):localStorage.removeItem("cachedFocus"),e},saveCachedFocus:function(e){var t=e.get("focus"),n=e.get("forDate"),i=e.get("completed");localStorage.cachedFocus=JSON.stringify({focus:t,forDate:n,cached:!0,completed:i})},cachedFocus:function(){if(localStorage.cachedFocus){var e=JSON.parse(localStorage.cachedFocus),t=getActiveDateString();if(e&&e.forDate===t){var n=new Backbone.Model(e);return n}}return null}}),m.collect.Focuses=m.collect.FocusesBase.extend({url:m.globals.urlRoot+"focus",saveOptions:{patch:!0}}),m.collect.FocusesLegacy=m.collect.FocusesBase.extend({localStorage:new Backbone.LocalStorage("momentum-focus"),saveOptions:{},onReset:function(){this.loadingFromServer=!1,this.fixNullForDate(),this.trigger("loadingFromServerChanged")},fixNullForDate:function(){var e=this.where({archived:!1,forDate:null});e&&e.length>0&&_.each(e,function(e){var t=e.get("createdDate");if(t){var n=Date.parse(t),i=activeDateStringForDate(n),o=getActiveDateString();i!=o&&e.archive()}else e.archive()},focus)}}),m.views.Focuses=Backbone.View.extend({attributes:{id:"focuses"},template:m.templates.focus["focuses-template"],events:{dblclick:"edit","mouseover .todays-focus":"onMouseOver","click .todays-focus":"onClickFocus","click .prompt":"onClickFocus","click .retry":"retryConnection"},offline:!0,loading:!1,clickedOnce:!1,retrying:!0,initialize:function(){this.listenTo(m,"newDay",this.changeDay,this),this.listenTo(m,"setNewFocus",this.setNewFocus,this),this.listenTo(m.collect.focuses,"change:archived",this.todayArchived),this.listenTo(m.collect.focuses,"reset",this.collectionReady),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:focusVisible",this.visibleChanged),this.renderedOnce=!1,this.lastStateFocused=!1,this.focusStateChanged=!0,this.render()},onMouseOver:function(){this.loading&&this.displayConnectingText(null,!0)},onClickFocus:function(){this.offline&&this.displayConnectingText(null,!0),this.clickedOnce=!0},visibleChanged:function(e){var t=m.models.customization.get("focusVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},collectionRequest:function(){this.loading=!0,this.clickedOnce||this.connectingTextOverride},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".message").addClass("loading"),this.$el.find(".message").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),t&&this.$el.find(".message").fadeIn(500)},collectionError:function(e,t,n){return 200===t.status?void this.successfulConnection():void this.failedConnection()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.displayConnectingText('<i class="loading-icon"></i>Loading...',!0),this.retrying=!0;var t=this;m.views.focusPrompt?m.syncCoordinator.pingApi(function(){t.successfulConnection(),m.views.focusPrompt&&m.views.focusPrompt.focusControl()},function(){t.failedConnection(!0)}):this.collection.fetch({reset:!0})},successfulConnection:function(){this.loading=!1,this.offline=!1,this.retrying=!1,this.dismissConnectionMessage()},failedConnection:function(e){this.loading=!1,this.offline=!0,this.render(),this.displayConnectingText('Trouble connecting… <a href="" class="retry">Retry</a>',e||this.clickedOnce)},dismissConnectionMessage:function(){"none"!=this.$(".message").css("display")&&this.$(".message").fadeOut(500)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render(),this.successfulConnection()},setNewFocus:function(){this.render(!0)},setFocusState:function(e){this.lastStateFocused==e?this.focusStateChanged=!1:this.focusStateChanged=!0,this.lastStateFocused=e},render:function(e){var t=!1;m.views.focusPrompt&&(t=m.views.focusPrompt.controlFocusedOnce);var n=this;if(this.renderedOnce)n.$el.find("li").fadeTo(0,0).remove(),n.$el.find(".prompt").fadeTo(0,0).remove();else{var i=(this.options.order||"append")+"To";this.$el[i]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1)}this.renderedOnce=!0;var o=null;return e||(o=this.collection.activeFocus()),o?(this.setFocusState(!0),m.views.todayFocus=new m.views.Focus({model:o}),n.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(this.focusStateChanged?500:0,1))):(this.setFocusState(!1),m.views.focusPrompt=new m.views.FocusPrompt({collection:this.collection}),this.$el.prepend(m.views.focusPrompt.render().$el.fadeIn(this.focusStateChanged?500:0)),t&&m.views.focusPrompt.focusControl()),this},addToday:function(e){ga("send","event","Focus","Save"),m.views.todayFocus=new m.views.Focus({model:e}),this.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(500,1))},successfullyCreatedNewFocus:function(){m.views.focuses.successfulConnection(),this.render()},changeDay:function(){m.collect.focuses.fetch({reset:!0})},todayArchived:function(){this.render()},edit:function(){}}),m.views.FocusPrompt=Backbone.View.extend({attributes:{"class":"prompt"},template:m.templates.focus["focus-prompt-template"],events:{click:"focusControl","focus input":"handleFocus","keypress input":"handleInput","blur input":"handleBlur"},initialize:function(){this.controlFocusedOnce=!1,this.listenTo(m,"globalEvent:toggleFocus",this.toggleShow),this.listenTo(m,"globalEvent:esc",this.hide),this.render()},render:function(){return this.$el.html(this.template()),this.$input=this.$el.find("input"),this.collection.loadingFromServer||this.$input.focus(),this},handleFocus:function(){this.controlFocusedOnce=!0,m.views.focuses.displayConnectingText()},focusControl:function(){this.$input.focus()},handleBlur:function(){this.controlFocusedOnce=!1,this.$el.removeClass("loading")},handleInput:function(e){this.collection.loadingFromServer&&e.preventDefault(),13==e.keyCode&&this.save()},save:function(){var e=this.$input[0].value.trim();if(e){var t=this;m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var n=getActiveDateString();m.collect.focuses.create({focus:e,day:"today",forDate:n},{wait:!0,success:function(){m.views.focuses.successfulConnection(),t.$el.fadeTo(500,0,function(){t.remove(),m.views.focuses.successfullyCreatedNewFocus()})},error:function(e,n,i){t.$input.addClass("pulse"),m.views.focuses.failedConnection(!0)}})}},toggleShow:function(){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.views.Focus=Backbone.View.extend({tagName:"li",attributes:{"class":"focus"},template:m.templates.focus["focus-template"],events:{"click .delete":"destroy","click .checkbox":"toggleCompleted"},initialize:function(){this.render(),this.listenTo(this.model,"change",this.render)},render:function(){var e=m.utils.captionFormatter(this.model.get("focus")),t={focus:e,day:"Today"};return this.$el.html(this.template(t)),this.$el.toggleClass("complete",this.model.get("completed")),this.$el.toggleClass("cached",this.model.get("cached")),this},destroy:function(){if(this.$el.hasClass("complete"))ga("send","event","Focus","Add New"),m.trigger("setNewFocus");else{ga("send","event","Focus","Delete");var e=this;this.$el.fadeTo(500,0,function(){e.model.archive(),e.remove()})}},toggleCompleted:function(){m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!1),this.model.toggleCompleted(),ga("send","event","Focus","Done")}}),m.bootstrappers.InitializeFocus=function(e,t){},m.bootstrappers.RenderFocus=function(e,t,n){e.conditionalFeatures.checkFeatureAndMigrateData("serverfocus","focusVisible","momentum-focus",function(){e.collect.focuses=new e.collect.Focuses,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(n),e.widgets.push(e.views.focuses)},function(){e.collect.focuses=new e.collect.FocusesLegacy,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(n),e.widgets.push(e.views.focuses)},function(t){e.listenToOnce(e.models.customization,"change:focusVisible",t)})},m.models.legacy=m.models.legacy||{},m.collect.legacy=m.collect.legacy||{},m.views.legacy=m.views.legacy||{},m.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0===t?!1:1==t},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t}}),m.models.legacy.Todo=m.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),m.models.legacy.TodoProxy=m.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.collect.legacy.TodosBase=Backbone.Collection.extend({model:m.models.legacy.Todo,saveOptions:{},initialize:function(){this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){var e=this.completeToday();return e.length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){
return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return void 0==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.legacy.Todos=m.collect.legacy.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){}).fail(function(e,t){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(e){this.saveCachedCompletedCount()},completedCount:function(){if(this.loadingFromServer)return this.cachedCompletedCount();var e=this.completeToday();return e.length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var e=this.completeToday(),t=e.length,n=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:t,forDate:n}),t!=this.previousCount&&(this.previousCount=t,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return e.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return!0}return!1}}),m.collect.legacy.TodosLegacy=m.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(){var e=!1,t=this.completeToday();_.each(t,function(t){var n=t.get("completedDate");if(n){var i=Date.parse(n),o=activeDateStringForDate(i);o!=getActiveDateString()&&(t.archive(),e=!0)}}),e&&this.trigger("reset")},reorderItem:function(e){var t=this.get(e.move_id),n=this.get(e.move_target_id),i=e.move_offset>0?1:-1,o=this.indexOf(n),s=1;if(o+i>=0&&o+i<this.length){var a=this.at(o+i);s=Math.abs(a.get("order")-n.get("order")),20>=s&&(this.createOrderGaps(),s=Math.abs(a.get("order")-n.get("order")))}var l=n.get("order")+Math.ceil(s/2)*i;t.save({order:l},{silent:!0})}}),m.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo","class":"todo"},template:m.templates.todos["todo-template"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],this.proxyCollection=new Backbone.Collection({model:m.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.$el.toggleClass("show"),this.doFetchIfNeeded())},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),setMaxWidgetHeight(),this.renderedOnce=!0}return this},visibleChanged:function(e){var t=m.models.customization.get("todoVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),m.conditionalFeatures.featureEnabled("localtodonotify"))){var e=this;window.addEventListener("storage",function(t){if(t.key&&0===t.key.indexOf("todos-updated")){if(e.fetching)return;e.fetching=!0,e.collection.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(e){if(localStorage.greetings){var t=JSON.parse(atob(localStorage.greetings)),e=t.todo;e&&(e.none&&(this.emptyTodoGreetings=e.none),e.completed&&(this.completedTodoGreetings=e.completed))}this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}]),this.completedTodoGreetings||(this.completedTodoGreetings=[{caption:"All done",message:"Great work, "},{caption:"All done",message:"Good job, "},{caption:"All done",message:"You are awesome, "},{caption:"All done",message:"Good one, "},{caption:"All done",message:"Good on ya, "},{caption:"All done",message:"Congratulations, "},{caption:"All done",message:"You did it, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var e=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(e,1)[0]}return this.emptyTodoGreeting},randomCompletedTodoGreetings:function(){if(this.initializeGreetings(),!this.completedTodoGreeting){var e=Math.floor(Math.random()*this.completedTodoGreetings.length);this.completedTodoGreeting=this.completedTodoGreetings.splice(e,1)[0]}return this.completedTodoGreeting},addOne:function(e){var t=new m.views.legacy.Todo({model:e,parent:this});this.subViews.push(t),this.$(".todo-list").append(t.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(e){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(e,t,n){return 200===t.status?void this.successfulConnection():void this.failedConnection()},successfulConnection:function(){var e=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),e&&this.trigger("connectionOnline")},failedConnection:function(e){this.offline=!0,this.displayConnectingText(e?e:'Trouble connecting… <a href="" class="retry">Retry</a>'),this.checkEmptyPaneState()},handleInput:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(e){e.preventDefault(),e.stopPropagation(),this.retryConnection()},retryConnection:function(){var e=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(t){e.createNewModel(t,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(t){e.saveToModel(t)})):this.collection.fetch({reset:!0})},createNewModel:function(e,t){var n=this;t?n.displayConnectingText('<i class="loading-icon"></i>Retrying...'):n.displayConnectingText('<i class="loading-icon"></i>Saving...'),e.set({saveFailed:!1,isLoading:!0}),n.collection.create({title:e.get("title")},{wait:!0,success:function(){n.successfulConnection(),e.set("proxyValid",!1),ga("send","event","Todo","Add")},error:function(t,i,o){n.failedConnection('Error saving… <a href="" class="retry">Retry</a>'),e.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(e,t){var n=this;n.displayConnectingText('<i class="loading-icon"></i>Saving...');var i=e.saveOptions();i.wait=!0,i.success=function(){var t={};jQuery.extend(t,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(t,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(t),n.successfulConnection()},50)},i.error=function(t,i,o){if(200==i.status){var s={};jQuery.extend(s,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(s),n.successfulConnection()},50)}else e.set({saveFailed:!0,isLoading:!1}),n.failedConnection('Error saving… <a href="" class="retry">Retry</a>')},t?(e.attemptedSaveValues?jQuery.extend(e.attemptedSaveValues,t):e.attemptedSaveValues=t,e.save(t,i)):e.attemptedSaveValues&&(t=e.attemptedSaveValues,e.save(e.attemptedSaveValues,i)),jQuery.extend(t,{saveFailed:!1,isLoading:!0}),e.set(t)},createOnEnter:function(e){var t=this.$el.find("#todo-new")[0].value.trim();if(t){var n=this,i=new m.models.legacy.TodoProxy({title:t});this.proxyCollection.add(i),n.$el.find("#todo-new")[0].value="",this.createNewModel(i)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},li_index:function(e){return this.$("li").index(e)},toggleShow:function(e){e&&e.preventDefault(),this.doFetchIfNeeded(),setMaxWidgetHeight(),$("#todo").toggleClass("show"),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList),this.$el.find("#todo-new").focus()},showCompleted:function(e){e.preventDefault(),e.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(e){$("#todo").hasClass("show")&&this.toggleShow()},openList:function(e){this.$el.find(".todo-list-chooser").show()},chooseList:function(e){this.$el.find(".todo-list-chooser").hide()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},collectionModelChanged:function(e){this.checkEmptyPaneState()},checkEmptyPaneState:function(){if(this.offline||this.show_completed)this.$el.find(".todo-pane").removeClass("is-empty");else if(0===this.collection.remaining().length)if(this.$el.find(".todo-pane").addClass("is-empty"),0===this.collection.completeToday().length){var e=this.randomEmptyTodoGreetings();this.$(".title").html(e.caption),m.models.customization.get("displayname")&&this.$(".description").html(e.message+m.models.customization.get("displayname"))}else{var t=this.randomCompletedTodoGreetings();this.$(".title").html(t.caption),m.models.customization.get("displayname")&&this.$(".description").html(t.message+m.models.customization.get("displayname")+"!")}else this.$el.find(".todo-pane").removeClass("is-empty");this.updateTodoCount()},updateTodoCount:function(){if(!this.offline){var e=this.collection.remaining().length;switch(e){case 0:;break;case 1:;break;default:}this.$(".todo-count").html(e+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),m.views.legacy.Todo=Backbone.View.extend({tagName:"li",template:m.templates.todos["todo-item-template"],events:{"click .toggle":"toggleDone","dblclick .view":"edit","click .destroy":"clear","keyup .edit":"handleInput","blur .edit":"abortEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(e){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=e.parent,this.listenTo(this.model,"change",this.render)},render:function(){var e="",t=m.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)var e="checked";var n={title:t,checked:e};return this.$el.html(this.template(n)),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this},destroy:function(){this.remove(),this.unbind()},clear:function(){ga("send","event","Todo","Delete"),this.$el.hide(),m.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing=!1,this.$el.find(".edit").val(this.model.get("title")),this.$el.removeClass("editing")},saveEdit:function(){this.editing=!1;var e=this.$el.find(".edit").val();e?(this.$el.removeClass("editing"),m.views.legacy.todos.saveToModel(this.model,{title:e})):this.clear()},retrySave:function(){this.model.isTrue("isProxy")?m.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&m.views.legacy.todos.saveToModel(this.model)},edit:function(e){this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.find(".edit").focus(),ga("send","event","Todo","Activate Edit"))},dragstart:function(e){return this.editing?!1:(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,void ga("send","event","Todo","Reorder"))},dragenter:function(e){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},dragleave:function(e){},toggleDone:function(){ga("send","event","Todo","Done");var e=!this.model.get("done");m.views.legacy.todos.saveToModel(this.model,{done:e,completedDate:e?new Date:null})},handleInput:function(e){13==e.keyCode&&(this.saveEdit(),ga("send","event","Todo","Edit")),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())}}),m.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete","class":"metric"},template:m.templates.todos["todo-complete-template"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var e=this.collection.completedCount(),t="todos";1==e&&(t="todo");var n={done:e,item:t},i=(this.options.order||"append")+"To";return this.$el[i]("#"+this.options.region).html(this.template(n)).fadeTo(500,1),e?this.$el.show():this.$el.hide(),this}}),m.bootstrappers.RenderTodos=function(e,t){var n=e.conditionalFeatures.featureEnabled("enhancedtodo");n?e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.views.todoPane=new e.views.TodoPane({region:"bottom-right",order:"append"}),e.widgets.push(e.views.todoPane)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(t){e.listenToOnce(e.models.customization,"change:todoVisible",t)}):e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.collect.legacy.todos=new e.collect.legacy.Todos,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(t){e.listenToOnce(e.models.customization,"change:todoVisible",t)})},m.models.Weather=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-weather"),defaults:{location:"",woeid:"",fetchUnit:"c"}}),m.views.Weather=Backbone.View.extend({attributes:{id:"weather","class":"metric weather"},template:m.templates.weather["weather-template"],events:{"dblclick .metric-stat":"toggleUnit","dblclick .location":"editLocation","keypress .location":"onKeypress","keydown .location":"onKeydown","blur .location":"saveLocation","webkitAnimationEnd .location":"onAnimationEnd"},initialize:function(){this.renderedOnce=!1;var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0),this.listenTo(this.model,"change",this.render),this.listenTo(m.models.customization,"change:temperatureUnit",this.render),this.listenTo(this.model,"change:manualLocation",this.updateWeather),this.updateWeather(),this.render(this.options.unitClass="hide"),this.listenTo(m.models.customization,"change:weatherVisible",this.visibleChanged),this.weatherTimer=setInterval(function(){this.updateWeather()}.bind(this),6e5)},render:function(){var e=this.calculateDisplayTemperature(),t=this.model.get("location");t&&0!=t.length||(t="location<br>unknown");var n={temperature:e,location:t,unit:this.displayUnit(),condition:this.model.get("condition"),code:this.getConditionFromCode(this.model.get("code")),unitClass:this.options.unitClass,message:this.model.get("error")},i=this.model.get("manualLocation");n.message&&i&&i.length>0&&(n.location=i);var o=(this.options.order||"append")+"To";return this.$el[o]("#"+this.options.region).html(this.template(n)).fadeTo(500,1),this.$location=this.$(".location"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("weatherVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},calculateDisplayTemperature:function(){var e=this.model.get("fetchTemperature");if(e){var t=this.model.get("fetchUnit");return"c"===this.displayUnit()?"c"===t?e:Math.round(5*(e-32)/9):"c"===t?Math.round(9*e/5+32):e}return null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},editLocation:function(){this.$el.hasClass("editing")||(this.$location.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$location.get(0)))},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$location.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveLocation())},onKeydown:function(e){27===e.keyCode&&(this.$location.html(this.model.get("location")),this.doneEditingLocation())},saveLocation:function(){this.model.save("manualLocation",this.$location.html()),this.doneEditingLocation(),ga("send","event","Weather","Set Manual Location")},doneEditingLocation:function(){this.$location.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},toggleUnit:function(){this.options.unitClass="","c"===this.displayUnit()?m.models.customization.save("temperatureUnit","f"):m.models.customization.save("temperatureUnit","c")},setUnit:function(e){var t=["US","BM","BZ","JM","PW"];t.indexOf(e)>=0?this.model.save("fetchUnit","f"):this.model.save("fetchUnit","c")},updateWeather:function(){m.commandManager.execute("weather.update",this.model)},getConditionFromCode:function(e){var t={};return t[0]="F",t[1]="F",t[2]="F",t[3]="O",t[4]="P",t[5]="X",t[6]="X",t[7]="X",t[8]="X",t[9]="Q",t[10]="X",t[11]="R",t[12]="R",t[13]="U",t[14]="U",t[15]="U",t[16]="W",t[17]="X",t[18]="X",t[19]="J",t[20]="M",t[21]="J",t[22]="M",t[23]="F",t[24]="F",t[25]="G",t[26]="Y",t[27]="I",t[28]="H",t[29]="E",t[30]="H",t[31]="C",t[32]="B",t[33]="C",t[34]="B",t[35]="X",t[36]="B",t[37]="O",t[38]="O",t[39]="O",t[40]="R",t[41]="W",t[42]="U",t[43]="W",t[44]="H",t[45]="O",t[46]="W",t[47]="O",t[3200]=")",t[e]}}),m.bootstrappers.RenderWeather=function(e,t){e.conditionalFeatures.checkPreferenceForRender("weatherVisible",function(){e.models.weather=new e.models.Weather({id:1}),e.models.weather.fetch(),e.views.weather=new e.views.Weather({model:e.models.weather,region:"top-right",order:"append"}),e.widgets.push(e.views.weather)},function(t){e.listenToOnce(e.models.customization,"change:weatherVisible",t)})},m.models.Message=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-message"),defaults:{title:"",message:"",views:0,viewLimit:3,visible:!1,loginOnClick:!1},showMessage:function(e,t,n,i){this.save({title:e,message:t,views:0,viewLimit:n,visible:!0,loginOnClick:i})},showMessageNow:function(e,t,n,i){this.save({title:e,message:t,views:0,viewLimit:n,visible:!0,loginOnClick:i}),m.views.message=new m.views.Message({model:this,region:"center-above",order:"append"}),m.widgets.push(m.views.message)},dismissMessage:function(){this.destroy()}}),m.models.UpdateMessage=Backbone.Model.extend({parse:function(e){this.set({version:e.version,title:e.title,message:e.message})}}),m.collect.UpdateMessages=Backbone.Collection.extend({model:m.models.UpdateMessage,url:"app/messages.json",parse:function(e){return e.messages}}),m.views.Message=Backbone.View.extend({id:"message",attributes:{"class":""},template:m.templates.message["message-template"],events:{"click .hide":"hideMessageClick",click:"messageClick"},initialize:function(){this.listenTo(this.model,"add",this.render),this.listenTo(this.model,"change",this.render),this.render()},render:function(){var e=this.model.get("visible");if(e){this.incrementViews();var t={title:this.model.get("title"),message:this.model.get("message")},n=(this.options.order||"append")+"To";return this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(t)).fadeTo(500,1).addClass("softpulse"),this}var i=this;i.$el.fadeTo(1e3,0,function(){i.remove()});var o=new m.collect.UpdateMessages;o.fetch({success:function(e,t){var n=chrome.app.getDetails().version,i=o.where({version:n})[0];if(i){var s=i.get("title"),a=i.get("message");s!==localStorage.lastMessageClickTitle&&m.models.message.showMessage(s,a,5,!1)}}})},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?(localStorage.lastMessageClickTitle=this.model.get("title"),this.model.save({visible:!1})):this.model.save({views:e},{silent:!0})},hideMessageClick:function(e){e.preventDefault(),e.stopPropagation(),localStorage.lastMessageClickTitle=this.model.get("title"),this.model.save({visible:!1})},messageClick:function(e){e.preventDefault(),localStorage.lastMessageClickTitle=this.model.get("title");var t=this.model.get("loginOnClick");t!==!0||localStorage.token||m.appView.removeAllViews(function(){m.views.introduction=new m.views.Introduction({region:"full"})}),this.model.save({visible:!1})}}),m.models.QuickLinks=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",local:!1,order:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({order:e},this.saveOptions())},comparator:"order"}),m.collect.QuickLinksBase=Backbone.Collection.extend({model:m.models.QuickLinks,initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},saveOptions:{},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",reorderItem:function(e){}}),m.collect.QuickLinks=m.collect.QuickLinksBase.extend({url:m.globals.urlRoot+"links",saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"links"}).done(function(e){}).fail(function(e,t){})}}),m.collect.QuickLinksLegacy=m.collect.QuickLinksBase.extend({localStorage:new Backbone.LocalStorage("momentum-quicklinks"),isLegacy:!0,fetch:function(e){var t=Backbone.Collection.prototype.fetch.call(this,e);return 0!==this.length||localStorage.gmailLinkAdded||(this.create({title:"Gmail",url:"http://mail.google.com/"}),localStorage.gmailLinkAdded=!0),t},createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},reorderItem:function(e){var t=this.get(e.move_id),n=this.get(e.move_target_id),i=e.move_offset>0?1:-1,o=this.indexOf(n),s=1;if(o+i>=0&&o+i<this.length){var a=this.at(o+i);s=Math.abs(a.get("order")-n.get("order")),20>=s&&(this.createOrderGaps(),s=Math.abs(a.get("order")-n.get("order")))}var l=n.get("order")+Math.ceil(s/2)*i;t.save({order:l},{silent:!0})}}),m.views.QuickLinks=Backbone.View.extend({attributes:{id:"quicklinks","class":"quicklinks top-widget"},template:m.templates.quicklinks["quicklinks-template"],offline:!0,initialFetchStarted:!1,events:{"click .quicklinks-show":"toggleShow","keypress #quicklinks-new-url":"createLink","keypress #quicklinks-new-title":"createLink","click .add":"showAdd","click .hide":"hideUsageHint","click .local":"handleLocal","click .retry":"retryConnection","click .quicklinks-new":"inputsClicked",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.renderedOnce=!1,this.render(),this.listenTo(m,"globalEvent:click globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleQuickLinks",this.toggleShow),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:linksVisible",this.visibleChanged),(this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchlinks"))&&this.doFetchIfNeeded()},render:function(){var e=(this.options.order||"append")+"To";return this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.$el[e]("#"+this.options.region).html(this.template()).fadeTo(500,1),this.renderedOnce=!0,this},destroy:function(){this.remove(),this.unbind()},visibleChanged:function(e){var t=m.models.customization.get("linksVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){this.initialFetchStarted||this.doFetch()},hideUsageHint:function(e){e.preventDefault(),e.stopPropagation(),m.models.customization.save({linksHintHidden:!0}),this.checkUsageHint()},collectionError:function(e,t,n){return 200===t.status?void this.successfulConnection():void this.failedConnection()},showAdd:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("#quicklinks-new-title").val(""),this.$el.find("#quicklinks-new-url").val(""),this.$el.find(".add").addClass("active"),this.$el.find(".quicklinks-new").toggle().find("#quicklinks-new-title").focus()},inputsClicked:function(e){e.stopPropagation()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.collection.fetch({reset:!0})},collectionReset:function(){this.addAll()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},addOne:function(e){var t=new m.views.QuickLink({model:e,parent:this});this.subViews.push(t),this.$(".quicklinks-pane ol").append(t.render().$el)},addAll:function(){this.offline=!1,_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.collection.each(this.addOne),this.successfulConnection()},successfulConnection:function(){this.$el.find(".connection-message").hide(),this.dismissConnectionError(),this.checkUsageHint()},failedConnection:function(){this.$el.find(".connection-message").html('Trouble connecting… <a href="" class="retry">Retry</a>'),this.$el.find(".connection-message").show(),this.checkUsageHint()},createLink:function(e){if(13==e.keyCode){var t=this.$el.find("#quicklinks-new-title")[0].value,n=this.$el.find("#quicklinks-new-url")[0].value;if(!t){var i=this;return this.$el.find("#quicklinks-new-title").addClass("pulse"),void _.delay(function(){i.$el.find("#quicklinks-new-title").removeClass("pulse")},1e3)}if(!n){var i=this;return this.$el.find("#quicklinks-new-url").addClass("pulse"),void _.delay(function(){i.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)}if(this.offline)return void this.revealConnectionError();var o=!1;/^chrome|chrome-extension|chrome-search:\/\//i.test(n)&&(o=!0),n=ensureUrlScheme(n),ga("send","event","Quick Links","Add");var i=this,s=0;if(this.collection.length>0){var a=this.collection.max(function(e){return e.get("order")});s=a.get("order")+100}this.collection.create({title:t,url:n,local:o,order:s},{wait:!0,success:function(){i.successfulConnection(),i.$el.find(".add").removeClass("active"),i.$el.find(".quicklinks-new").css("display","none")},error:function(e,t,n){i.failedConnection(),i.revealConnectionError()}})}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"quicklink"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),this.doFetchIfNeeded(),setMaxWidgetHeight(),$("#quicklinks").toggleClass("show")},hide:function(e){e!=this&&$("#quicklinks").hasClass("show")&&($("#quicklinks").removeClass("show"),this.$el.find(".quicklinks-new").css("display","none"),this.$el.find(".add").removeClass("active"))},li_index:function(e){return this.$("li").index(e)},urlInvalid:function(){var e=this;this.$el.find("#quicklinks-new-url").addClass("pulse"),_.delay(function(){e.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)},handleLocal:function(e){e.preventDefault(),ga("send","event","Quick Links","Local Link"),chrome.tabs.update({url:e.currentTarget.href})},checkUsageHint:function(){var e=m.models.customization.get("linksHintHidden");this.offline||e?this.$el.find(".message").hide():this.$el.find(".message").show()}}),m.views.QuickLink=Backbone.View.extend({tagName:"li",template:m.templates.quicklinks["quicklinks-item-template"],events:{"keypress .todo-input":"updateOnEnter","click .destroy":"delete",dragstart:"dragstart",dragenter:"dragenter",click:"handleClick","click .local":"handleLocal"},initialize:function(e){_.bindAll(this,"dragstart","dragenter"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove)},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),n=this.model.get("url"),i=this.model.get("local"),o=new Image;return o.src="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(n)+".ico",o.onload=function(){var s={title:t,url:n,local:i};48!==o.width?s.favicon_url="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(n)+".ico":s.favicon_url="https://icons.duckduckgo.com/ip2/"+detachUrlScheme(n)+".ico",
e.$el.html(e.template(s)),e.$el.prop("draggable","true")},e},"delete":function(){ga("send","event","Quick Links","Delete"),this.model.destroy()},dragstart:function(e){e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="quicklink",this.parent.dragging=this},dragenter:function(e){if("quicklink"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},handleClick:function(e){e.stopPropagation()},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.bootstrappers.RenderQuickLinks=function(e,t){e.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","linksVisible","momentum-quicklinks",function(){e.collect.quicklinks=new e.collect.QuickLinks,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(){e.collect.quicklinks=new e.collect.QuickLinksLegacy,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(t){e.listenToOnce(e.models.customization,"change:linksVisible",t)})},m.models.Customization=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaults:{linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!0,requestSync:!1},initialize:function(){var e=this;e.fetching=!1,this.listenToOnce(this,"sync",this.migrateOldSettings),window.addEventListener("storage",function(t){t.key&&0===t.key.indexOf("momentum-customization-1")&&(e.fetching=!0,e.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0}))},!1)},migrateOldSettings:function(e){if(void 0===this.get("hour12clock")&&(localStorage.hour12clock?(this.save({hour12clock:JSON.parse(localStorage.hour12clock||!0)}),localStorage.removeItem("hour12clock")):this.save({hour12clock:!0})),void 0===this.get("displayname")&&(localStorage.name?(this.save({displayname:localStorage.name}),localStorage.removeItem("name")):this.save({displayname:null})),void 0===this.get("linksHintHidden")&&(localStorage.linksHintHidden?(this.save({linksHintHidden:JSON.parse(localStorage.linksHintHidden||!1)}),localStorage.removeItem("linksHintHidden")):this.save({linksHintHidden:!1})),void 0===this.get("temperatureUnit")){var t=JSON.parse(localStorage.getItem("momentum-weather-1"));if(t){var n=t.unit;n?this.save({temperatureUnit:n}):this.save({temperatureUnit:"c"})}else this.save({temperatureUnit:"c"})}}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){var e={};return this.$el.html(this.template(e)),this},close:function(){this.remove(),this.unbind()}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{id:"settings-main","class":"settings-container"},template:m.templates.settings.main,events:{"click .hide":"hideSettings","click .main-nav-item":"onClickNavItem"},navItems:[{id:"general",title:"General"}],secondaryNavItems:[{id:"help",title:"Help"},{id:"about",title:"About"}],detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){var e={navItems:this.navItems,secondaryNavItems:this.secondaryNavItems};if(this.renderedOnce)this.$el.html(this.template(e));else{var t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(this.template(e)).fadeTo(500,1),this.renderedOnce=!0,this.visible||this.$el.hide()}this.renderActivePanel()},renderActivePanel:function(){if(this.activePanel){var e=this.activePanel.render().el,t=this.$el.find(".subpanel-container");t.html(e)}},onClickNavItem:function(e){var t=$(e.currentTarget).data("navitem");this.activateSection(t)},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},hideSettings:function(){this.visible=!1,m.trigger("settings:hidden"),this.$el.hide()},showSettings:function(e){this.visible=!0,this.render(),m.trigger("settings:visible"),e&&e.section?this.activateSection(e.section):this.activateSection("general"),this.$el.show()},activateSection:function(e){if(e){$(".main-nav-item").removeClass("active"),$('li[data-navitem="'+e+'"]').addClass("active");var t=_.findWhere(this.subViews,{panelid:e});if(t)this.activePanel=t;else{this.activePanel&&this.activePanel.close();var n=e.charAt(0).toUpperCase()+e.slice(1),i=m.views.settings.panels[n];i&&(t=new i,this.activePanel=t)}this.renderActivePanel()}},setNavItems:function(e){this.navItems=e},setSecondaryNavItems:function(e){this.secondaryNavItems=e}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"preferences"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),m.views.settings.mainSettings=new m.views.settings.MainSettings({region:"settings-container",order:"prepend"}),m.widgets.push(m.views.mainSettings),this.listenTo(m,"globalEvent:esc globalEvent:click",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){if(!this.renderedOnce){var e=' <div class="pane preferences-pane light"></div><i class="icon-cog toggle"></i>',t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(e).fadeTo(500,1),this.renderedOnce=!0,setTimeout(function(){m.views.settings.mainSettings.render()},100)}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){$("#preferences").addClass("show")},settingsHidden:function(e){e&&e.preventDefault(),$("#preferences").removeClass("show")}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this,t=this.options.email,n=this.options.size,i=!1,o=this.$el.on("error",function(){i||(i=!0,e.$el.attr({src:"/img/gravatar_unknown.jpg"}))}).attr({src:"https://www.gravatar.com/avatar/"+md5(t)+"?s="+n+"&d=mm"});return this.$el.html(o),this}}),m.views.settings.panels.About=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help","class":"subpanel-container"},template:m.templates.settings.about,panelid:"about",events:{"dblclick #momo-version":"revealUuid"},render:function(){var e={version:m.globals.version};return this.$el.html(this.template(e)),this},revealUuid:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find(".made").html(localStorage.client_uuid)}}),m.views.settings.panels.General=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-general","class":"subpanel-container"},template:m.templates.settings.general,panelid:"general",syncState:!1,events:{"click .slide-toggle":"toggleSlider","click .sync-option":"toggleSyncSlider","click .toggle-option":"toggleOption","click .login":"loginClicked","click .action-logout":"logoutClicked"},customizeItems:[{name:"Show Focus",widget:"focusVisible",field:"focusVisible"},{name:"Show Quick Links",widget:"linksVisible",field:"linksVisible"},{name:"Show Todo",widget:"todoVisible",field:"todoVisible"},{name:"Show Weather",widget:"weatherVisible",field:"weatherVisible"},{name:"Show Quote",widget:"quoteVisible",field:"quoteVisible"},{name:"Show Search",widget:"searchVisible",field:"searchVisible"},{name:"Search",field:"searchProvider",widget:"search-provider",options:[{label:"Google",value:"google"},{label:"Bing",value:"bing"}]},{name:"Clock Format",field:"hour12clock",widget:"clock-format","boolean":!0,options:[{label:"12 hour",value:!0},{label:"24 hour",value:!1}]},{name:"Weather Units",field:"temperatureUnit",widget:"temp-unit",options:[{label:"°C",value:"c"},{label:"°F",value:"f"}]}],initialize:function(){this.model=m.models.customization,this.listenTo(m.models.customization,"change",this.customizationModelChanged)},render:function(){var e=m.models.customization.get("displayname"),t=localStorage.email||null,n=!!localStorage.token,i=null;if(m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")?(i={name:"Account Sync Enabled",message:"Your account will now sync"},this.syncState=!0):m.models.customization.get("requestSync")&&localStorage.token?(i={name:"Account Sync Requested",message:"We'll notify you when activated"},this.syncState=!0):(i={name:"Request Account Sync",message:"Join the account sync beta"},this.syncState=!1),this.$el.html(this.template({displayname:e,email:t,loggedIn:n,sync:i})),t){var o=this.$el.find(".user-gravatar");if(o){var s=new m.views.Gravatar({email:t,size:50});o.html(s.render().$el)}}this.$synclist=this.$el.find(".sync-option"),this.updateSyncToggleState();var a=this.$el.find("#customize-list");return a.empty(),_.each(this.customizeItems,function(e){e.options?a.append(m.templates.settings["general-toggle-options"](e)):a.append(m.templates.settings["general-toggle-slider"](e))}),this.updateControlStates(_.pluck(this.customizeItems,"field")),this},updateSyncToggleState:function(){this.$synclist&&(this.syncState?this.$synclist.find(".toggle-slider").hide():this.$synclist.find(".toggle-slider").show(),this.$synclist.toggleClass("one-way-enabled",this.syncState))},updateSyncMessage:function(e){this.$synclist&&this.$synclist.find(".option-message").html(e)},updateSyncCaption:function(e){this.$synclist&&this.$synclist.find(".sync-caption").html(e)},toggleSyncSlider:function(e){var t=this;if(!this.syncState){var n=m.models.customization.get("requestSync");localStorage.token?n?t.render():m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){m.models.customization.save({requestSync:!0}),t.updateSyncCaption("Account Sync Requested"),t.updateSyncMessage("We'll notify you when activated"),t.syncState=!0,t.updateSyncToggleState()},function(){t.syncState=!1,t.updateSyncToggleState(),t.updateSyncCaption("Account Sync Access Request Failed"),t.updateSyncMessage("Be sure that you are connected to the Internet and try again."),t.syncState=!1,t.updateSyncToggleState()}):(t.updateSyncCaption("Login required for Account Sync"),t.updateSyncMessage("Click Login above to create an account or log into your existing account and try again."),t.syncState=!1,t.updateSyncToggleState())}},customizationModelChanged:function(e){var t=e.changedAttributes(),n=_.keys(t);this.updateControlStates(n)},updateControlStates:function(e){var t=this;_.each(e,function(e){var n=_.findWhere(t.customizeItems,{field:e});if(n)if(n.options){var i=t.model.get(e);t.$el.find("."+n.widget).removeClass("active"),t.$el.find("."+n.widget+"[data-option-value='"+i+"']").addClass("active")}else{var o=t.$el.find("[data-related-widget='"+n.widget+"']");if(o&&1===o.length){var s=o.first();s.toggleClass("on",t.model.get(e))}}})},toggleOption:function(e){var t=e.currentTarget,n=$(e.currentTarget).attr("data-related-widget"),i=$(e.currentTarget).attr("data-option-value");this.$el.find("."+n).removeClass("active"),$(t).addClass("active");var o=_.findWhere(this.customizeItems,{widget:n});if(o){var s={};o["boolean"]?s[o.field]=JSON.parse(i):s[o.field]=i,this.model.save(s)}},toggleSlider:function(e){e.stopPropagation();var t=$(e.currentTarget).attr("data-related-widget");if(t){var n=!this.model.get(t),i={};i[t]=n,this.model.save(i)}},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.commandManager.execute("settings.hide"),m.appView.removeAllViews(function(){m.views.introduction=new m.views.Introduction({region:"full"})}),ga("send","event","Settings","Login","Clicked")},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),this.logout(),m.commandManager.execute("settings.hide")},logout:function(){var e=this;if(ga("send","event","Settings","Logout","Clicked"),localStorage.token&&localStorage.token_uuid){var t={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){e.success&&1==e.success&&m.models.message.showMessage("Logged out","You have been logged out.",2,!1)}).fail(function(e,t){}).always(function(t,n){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.models.customization.save("requestSync",!1),m.trigger("user:successfulLogout"),e.render()})}else localStorage.removeItem("token"),m.trigger("user:successfulLogout"),msg.success&&1==msg.success&&m.models.message.showMessage("Logged out","You have been logged out.",12,!1),this.render()}}),m.views.settings.panels.Help=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help","class":"subpanel-container"},template:m.templates.settings.help,panelid:"help",initialize:function(){}}),m.views.Introduction=Backbone.View.extend({attributes:{id:"introduction","class":"light"},template:m.templates.introduction["introduction-template"],initialize:function(){this.activeView=null,this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(1e3,1),m.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},promptForName:function(){ga("send","event","Introduction","Name","Show"),m.views.namePrompt=new m.views.NamePrompt,this.activeView=m.views.namePrompt,this.$el.find(".content").append(m.views.namePrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForEmail:function(){m.views.emailPrompt=new m.views.EmailPrompt,this.activeView=m.views.emailPrompt,this.$el.find(".content").append(m.views.emailPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordLogin:function(){ga("send","event","Introduction","Password For Login","Show"),m.views.loginPasswordPrompt=new m.views.LoginPasswordPrompt,this.activeView=m.views.loginPasswordPrompt,this.$el.find(".content").append(m.views.loginPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordCreate:function(){ga("send","event","Introduction","Password For Create","Show"),m.views.createPasswordPrompt=new m.views.CreatePasswordPrompt,this.activeView=m.views.createPasswordPrompt,this.$el.find(".content").append(m.views.createPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordReset:function(){ga("send","event","Introduction","Password For Reset","Show"),m.views.resetPasswordPrompt=new m.views.ResetPasswordPrompt,this.activeView=m.views.resetPasswordPrompt,this.$el.find(".content").append(m.views.resetPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},doneIntroductionWithMessage:function(){this.$el.fadeTo(1e3,0,function(){m.appView.render(!0)})},showLoading:function(){this.$el.find(".tip").html('<div class="loading"><span class="loading-icon"></span>Loading...</div>').css("opacity","0").fadeTo(500,1)},hideLoading:function(){}}),m.views.NamePrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},render:function(){var e="Hello, what's your name?",t={message:e};return this.$el.html(this.template(t)),this},updateOnEnter:function(e){13==e.keyCode&&this.save()},save:function(){ga("send","event","Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(m.models.customization.save({displayname:t}),this.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForEmail()}))}}),m.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your email, "+m.models.customization.get("displayname")+"?",n={message:t},i=new m.views.IntroductionButton({value:"Stay logged out",clicked:function(){return e.stayOffline()}});return this.$el.html(this.template(n)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(i.render().$el),this.$el.find("input")[0].focus(),this},handleBack:function(e){ga("send","event","Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){13==e.keyCode&&this.checkEmail()},stayOffline:function(){ga("send","event","Introduction","Email","Stay Offline Clicked"),localStorage.stayOffline=!0,m.views.introduction.doneIntroductionWithMessage()},checkEmail:function(){ga("send","event","Introduction","Email","Submit");var e=this,t=this.$el.find("input")[0].value.trim();if(!(t.length<1)){var n=validateEmail(t);if(!n){var i=new m.views.IntroductionTip({value:"Sorry, "+t+" doesn't seem to be a valid email address. Please try again."});return void this.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,localStorage.email=t,m.views.introduction.showLoading(),$.ajax({type:"HEAD",url:m.globals.urlRootLogin+"user/"+t}).done(function(t){e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordLogin()}),m.views.introduction.hideLoading(),e.loading=!1}).fail(function(t,n){return 404!==t.status?(e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)):(e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordCreate()}),e.loading=!1,m.views.introduction.hideLoading(),void 0)}))}}}),m.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your password?",n={message:t},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}}),o=new m.views.IntroductionButton({value:"Change your password",clicked:function(){return e.resetPassword()}});return this.$el.html(this.template(n)),this.$el.find(".buttons").append(i.render().$el),this.$el.find(".buttons").append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){ga("send","event","Introduction","Password For Login","Escape Pressed"),this.changeEmail(e)},updateOnEnter:function(e){13==e.keyCode&&this.login()},changeEmail:function(e){ga("send","event","Introduction","Password For Login","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},resetPassword:function(e){ga("send","event","Introduction","Password For Login","Reset Password Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForPaswordReset()})},login:function(){ga("send","event","Introduction","Password For Login","Submit");var e=this,t=localStorage.email,n=this.$el.find("input")[0].value;if(n.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:t,password:n}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/authenticate"}).done(function(t){e.loading=!1,t.token&&(m.models.message.dismissMessage(),localStorage.token=t.token,t.token_uuid&&(localStorage.token_uuid=t.token_uuid),t.features&&m.conditionalFeatures.setFeatures(t.features),m.trigger("user:successfulLogin",function(){m.views.introduction.doneIntroductionWithMessage()}),m.views.introduction.hideLoading())}).fail(function(t,n){if(400!==t.status)return e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1);var i=new m.views.IntroductionTip({value:"The password you entered for the email "+localStorage.email+" isn't right."});e.$el.find(".tip").html(i.render().$el.fadeTo(500,1)),e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="Please choose a password.",n={message:t},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});return this.$el.html(this.template(n)),this.$el.find("input").attr("type","password").focus(),this.$el.find(".buttons").append(i.render().$el),this},updateOnEnter:function(e){13==e.keyCode&&this.create()},handleBack:function(e){ga("send","event","Introduction","Password For Create","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){ga("send","event","Introduction","Password For Create","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},create:function(){ga("send","event","Introduction","Password For Create","Submit");var e=this,t=localStorage.email,n=this.$el.find("input")[0].value;if(n.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:n,version:m.globals.version}),url:m.globals.urlRootLogin+"user/register"}).done(function(e){e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid)):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=Date.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),m.models.message.showMessage("Account almost ready","Your activation email should arrive in a few moments.",10,!1),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){m.views.introduction.hideLoading(),e.loading=!1}))}}),m.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(e){var t=this,n="What would you like your new password to be?",i={message:n},o=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}});return this.$el.html(this.template(i)),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){ga("send","event","Introduction","Password For Reset","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){ga("send","event","Introduction","Password For Reset","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},updateOnEnter:function(e){13==e.keyCode&&this.reset()},reset:function(){ga("send","event","Introduction","Password For Reset","Submit");var e=this,t=localStorage.email,n=this.$el.find("input")[0].value;if(n.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:n}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/forgot"}).done(function(e){m.models.message.showMessage("Password change started","Check your email to change your password. Your password change email may take a few moments to arrive.",10,!1),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.IntroductionTip=Backbone.View.extend({template:m.templates.introduction["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this}}),m.views.IntroductionButton=Backbone.View.extend({template:m.templates.introduction["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this},clicked:function(e){this.options.clicked()}}),m.views.TodoPane=Backbone.View.extend({attributes:{id:"todo","class":"todo"},renderedOnce:!1,events:{"click .todo-toggle":"toggleShow"},todoListOpen:!1,libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenToOnce(m.views.background,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:esc globalEvent:click",this.setTodoStateClosed),this.listenTo(m,"todo:visible",this.todoVisible),this.listenTo(m,"todo:hidden",this.todoHidden),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged)},render:function(){if(!this.renderedOnce){var e='<div class="todo-pane-container"><div class="pane todo-pane"><div class="todo-header"><ul class="todo-list-active"><li><span class="todo-list-name"></span><span class="todo-count active-todo-count"><i class="loading-icon"></i> Loading...</span></li></ul></div><ol class="todo-list"></ol><input id="todo-new" class="todo-input todo-new" type="text" placeholder="New todo" /></div></div><span class="toggle todo-toggle medium">Todo</span></div>',t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(e).fadeTo(500,1),this.$panecontainer=this.$el.find(".todo-pane-container")[0],$("#todo").toggleClass("show",this.todoListOpen),this.renderedOnce=!0}return this.checkBackgroundLoadedAndKickOffLibraryLoad(),this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.trigger("globalEvent:closeDropdowns");var t=!this.todoListOpen;this.reactTodoPane?this.reactTodoPane.setTodoOpenState(t):(t?this.todoVisible():this.todoHidden(),this.checkBackgroundLoadedAndKickOffLibraryLoad()),setMaxWidgetHeight()},setTodoStateClosed:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.el,e.target)||this.reactTodoPane.setTodoOpenState(!1))},todoVisible:function(){this.todoListOpen=!0,$("#todo").addClass("show")},todoHidden:function(){this.todoListOpen=!1,$("#todo").removeClass("show")},onBackgroundLoaded:function(){this.checkBackgroundLoadedAndKickOffLibraryLoad()},checkBackgroundLoadedAndKickOffLibraryLoad:function(){m.views.background.isBackgroundLoaded&&!this.libraryLoadStarted&&(this.libraryLoadStarted=!0,m.react.TodoItemList?this.switchToReactVersion():this.loadReactLibraries())},loadReactLibraries:function(){var e=this;$.getScript("js/lib.2.min.js").done(function(t,n){e.loadReactTodoLibrary()}).fail(function(e,t,n){})},loadReactTodoLibrary:function(){var e=this;$.getScript("app/app.2.min.js").done(function(t,n){e.switchToReactVersion()}).fail(function(e,t,n){})},switchToReactVersion:function(){m.models.todoListManager=new m.models.TodoListManager({prefetchTodos:this.todoListOpen}),this.reactTodoPane=ReactDOM.render(React.createElement(m.react.TodoPane,{todoListManager:m.models.todoListManager}),this.$panecontainer),this.reactTodoPane.setTodoOpenState(this.todoListOpen),setMaxWidgetHeight()},visibleChanged:function(e){var t=m.models.customization.get("todoVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)}}),m.views.Greeting=Backbone.View.extend({id:"greeting",template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e=this.getPeriod(),t=m.models.customization.get("displayname"),n={period:e,name:t},i=(this.options.order||"append")+"To";this.$el[i]("#"+this.options.region).fadeTo(0,0).html(this.template(n)).fadeTo(500,1),this.$period=this.$(".period"),this.$name=this.$(".name")},getPeriod:function(){var e,t=this.model.get("date"),n=t.getHours();return n>=3&&12>n&&(e="morning"),n>=12&&17>n&&(e="afternoon"),(n>=17||3>n)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1).addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.html();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")}}),m.views.CenterClock=Backbone.View.extend({id:"centerclock",template:m.templates.centerclock["centerclock-template"],events:{dblclick:"toggleFormat"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updateTime,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e=this.model.getTimeString(),t={time:e},n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(t)).fadeTo(500,1),this.$time=this.$(".time"),this.$format=this.$(".format")},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e)},toggleFormat:function(){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e)},setTimeFormat:function(e){e?(setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")},updateTime:function(){this.$time.html(this.model.getTimeString())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){var t=e.actionParameter,n=0;
if(t&&t.status&&"authRequired"==t.status&&t.authorizationUrl&&2>n){n++;var i=t.winWidth?t.winWidth:600,o=t.winHeight?t.winHeight:510,s=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-i/2,l=window.screen.height/2-o/2,r=window.open(t.authorizationUrl,"MomentumAuthWindow",s+",left="+a+",top="+l+",width="+i+",height="+o),c=setInterval(function(){r.closed&&(clearInterval(c),m.models.todoListManager.doFetchIfNeeded(!0))},250)}}}),m.commands.SettingsDisplay=m.models.Command.extend({defaults:{id:"settings.display"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.showSettings(t)}}),m.commands.SettingsToggle=m.models.Command.extend({defaults:{id:"settings.toggle"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.toggleVisible()}}),m.commands.SettingsHide=m.models.Command.extend({defaults:{id:"settings.hide"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.hideSettings()}}),m.commands.TodoMove=m.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(e,t){e.attemptSave({listId:t.target_id})},canExecute:function(e,t){return t?e.get("done")?!1:e.get("listId")==t.target_id?!1:!0:!1}}),m.commands.TodoMoveToListType=m.models.Command.extend({defaults:{id:"todo.move.type"},execute:function(e,t,n){var i=n.getListOfType(t.target);return i?void e.attemptSave({listId:i.id}):!1},canExecute:function(e,t,n){if(!t)return!1;if(e.get("done"))return!1;var i=n.getListOfType(t.target);return i?e.get("listId")==i.id?!1:!0:!1}}),m.commands.TodoMoveDone=m.models.Command.extend({defaults:{id:"todo.move.done"},execute:function(e,t,n){var i=n.getListOfType("done");return i?void e.attemptSave({listId:i.id}):!1},canExecute:function(e,t,n){if(e.get("done")){var i=n.getListOfType("done");return i?e.get("listId")==i.id?!1:!0:!1}return!1}}),m.commands.TodoDelete=m.models.Command.extend({defaults:{id:"todo.delete"},execute:function(e){e.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},canExecute:function(e,t){return e.get("done")?!1:!0}}),m.commands.TodoRetryConnection=m.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(e){m.models.todoListManager&&m.models.todoListManager.doFetchIfNeeded(!0)}}),m.commands.TodoListDefaultCommand=m.models.Command.extend({defaults:{id:"todo.list.defaultcommand"},execute:function(e,t){if(t&&t.get("done"))return{captionText:"Archive to Done",commandId:"todo.move.done"};var n=e.get("id");return"today"==n?{captionText:"Move to Inbox",commandId:"todo.move",options:{target:"inbox"}}:"inbox"==n?{captionText:"Move to Today",commandId:"todo.move",options:{target:"today"}}:null}}),m.commands.TodoListArchiveAllDone=m.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(e,t){if(e&&!e.isDoneList()){var n=m.collect.todos.completeToday();_.each(n,function(e){e.archive()})}},canExecute:function(e){if(e&&e.isDoneList())return!1;var t=e.itemCollection;return t&&t.completedCount()>0?!0:!1}}),m.commands.TodoProviderChange=m.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(e,t){t&&t.provider_id&&m.models.todoListManager.changeProvider(t.provider_id)}}),m.commands.WeatherProcessFetched=m.models.Command.extend({defaults:{id:"weather.process.fetched"},execute:function(e,t){var n={latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy,placedata:t},i=new Date,o="weather-loc-"+i.getTime();localStorage.setItem(o,JSON.stringify(n))}}),m.commands.WeatherUpdate=m.models.Command.extend({defaults:{id:"weather.update"},execute:function(e,t){this.updateWeather(e)},updateWeather:function(e){function t(){navigator.geolocation.getCurrentPosition(i,o)}function n(t){var n={};e.get("location")!=t.location_name&&(n.location=t.location_name),e.get("woeid")!=t.woeid&&(n.woeid=t.woeid),e.set(n)}function i(e){try{var t=!0,i=c.getLastWeatherLocation();i&&+i.latitude.toFixed(3)==+e.coords.latitude.toFixed(3)&&+i.longitude.toFixed(3)==+e.coords.longitude.toFixed(3)&&(t=!1,n(i),r(i.woeid)),t&&l("("+e.coords.latitude+","+e.coords.longitude+")",e.coords)}catch(o){console.log(o)}}function o(t){console.log("Error getting location: "+t.code+", msg: "+t.message),e.get("manualLocation")&&l("")}function s(e){var t={woeid:e.woeid};return e.locality1&&e.locality1.content?t.city=e.locality1.content:t.city=e.name,e.country&&(t.countrycode=e.country.code),t}function a(t){var n="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(n,function(n){var i=n.query.count,o=null,a=!1;if(i>1?(a=!0,o=s(n.query.results.place[0])):1==i?n.query.results.place&&(a=!0,o=s(n.query.results.place)):e.save("error","not found"),a){var l={enteredLocation:t,woeid:o.woeid,location_name:o.city};localStorage.setItem("manual-weather-location",JSON.stringify(l))}if(o&&o.countrycode&&(e.get("location")||c.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var d=o.city,u=o.woeid;e.save({location:d,woeid:u,error:null}),r(u)}}).error(function(e){console.log("Error getting WoeID")})}function l(t,n){e.get("manualLocation")&&(t=e.get("manualLocation"));var i="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(i,function(t){var i=t.query.count,o=null;if(i>1)validYQLResult=!0,o=s(t.query.results.place[0]);else if(1==i)t.query.results.place&&(validYQLResult=!0,o=s(t.query.results.place));else{var a=c.getLastWeatherLocation();a?o={woeid:a.woeid,city:a.location}:e.save("error","not found")}try{if(validYQLResult&&n){var l={latitude:n.latitude,longitude:n.longitude,woeid:o.woeid,location_name:o.city};localStorage.setItem("last-weather-location",JSON.stringify(l)),m.commandManager.execute("weather.process.fetched",n,t.query.results)}}catch(d){console.log(d)}if(o&&o.countrycode&&(e.get("location")||c.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var a=o.city,u=o.woeid;e.save({location:a,woeid:u,error:null}),r(u)}}).error(function(e){console.log("Error getting WoeID")})}function r(t){var n=c.displayUnit();n||(n="c");var i="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+t+' and u="'+n+'"')+"&format=json";$.getJSON(i,function(t){if(t&&t.query&&1==t.query.count){var i=t.query.results.channel.item.condition;i&&e.save({fetchTemperature:i.temp,fetchUnit:n,code:i.code,condition:i.text,updated:new Date,error:null})}}).error(function(e){console.log("Error getting weather data: "+e)})}var c=this,d=e.get("manualLocation");if(d&&d.length>0){var u=c.getManualWeatherLocation();u&&u.enteredLocation==d?(n(u),r(u.woeid)):a(d)}else t()},setUnit:function(e,t){var n=["US","BM","BZ","JM","PW"];n.indexOf(e)>=0?t.save("fetchUnit","f"):t.save("fetchUnit","c")},getLastWeatherLocation:function(){var e=localStorage.getItem("last-weather-location");return e?JSON.parse(e):null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},getManualWeatherLocation:function(){var e=localStorage.getItem("manual-weather-location");return e?JSON.parse(e):null}}),m.isValidDate=function(e){return"[object Date]"!==Object.prototype.toString.call(e)?!1:!isNaN(e.getTime())},m.models.Date=Backbone.Model.extend({defaults:function(){var e=new Date;return{date:e}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},getTimeString:function(e){var t=m.models.customization.get("hour12clock");e=e||this.get("date");var n=e.getHours(),i=e.getMinutes();return 1==t&&(n=(n+11)%12+1),10>n&&!t&&(n="0"+n),10>i&&(i="0"+i),n+":"+i},getTimePeriod:function(){return this.get("date").getHours()>=12?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){m.models.customization=new m.models.Customization({id:1}),m.models.customization.fetch({error:function(){m.models.customization.save()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.date=new m.models.Date,m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds}),m.views.background=new m.views.Background({model:m.models.activeBackground,region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({model:m.models.activeBackground,region:"bottom-left"}),m.collect.backgrounds.fetch({reset:!0}),m.collect.legacyBackgrounds.fetch({reset:!0}),m.models.message=new m.models.Message({id:1}),m.models.message.fetch(),m.bootstrappers.InitializeFocus(m,$),m.bootstrappers.InitializeQuote(m,$),this.dateIntervalId=setInterval(function(){m.models.date.set("date",new Date)},100),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),m.models.customization.get("displayname")?this.render():m.views.introduction=new m.views.Introduction({region:"full"}),this.initializeCompleted=!0},processAddIns:function(){var e=this;e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending(),m.conditionalFeatures.featureEnabled("randomWidget")&&(m.models.genericWidget=new m.models.GenericWidget,m.views.genericWidget=new m.views.GenericWidget({model:m.models.genericWidget,region:"top-right",order:"prepend"}),m.widgets.push(m.views.genericWidget)))},50)},render:function(e){m.bootstrappers.RenderQuote(m,$,e),m.bootstrappers.RenderFocus(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.bootstrappers.RenderSearch(m,$),m.bootstrappers.RenderQuickLinks(m,$),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.bootstrappers.RenderTodos(m,$),m.bootstrappers.RenderWeather(m,$),m.models.message=new m.models.Message({id:1}),m.models.message.fetch(),m.views.message=new m.views.Message({model:m.models.message,region:"center-above",order:"append"}),m.widgets.push(m.views.message)},getViewById:function(e){var t=null;return _.each(m.widgets,function(n){n.el.id===e&&(t=n)}),t},removeView:function(e){_.each(m.widgets,function(t){t.el.id===e&&t.$el.fadeTo(500,0,function(){t.remove(),m.widgets.splice(m.widgets.indexOf(t),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){m.utils.captionFormatter=function(e){return e},m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.twoDigit=twoDigit,m.conditionalFeatures=new m.models.ConditionalFeatures,$(document).click(function(e){m.trigger("globalEvent:click",e)}),$(document).keyup(function(e){switch(e.which){case 27:m.trigger("globalEvent:esc",e)}}),$(document).keydown(function(e){if(!(e.ctrlKey||e.altKey||e.metaKey||e.shiftKey)&&"INPUT"!=document.activeElement.tagName&&1!=document.activeElement.isContentEditable){if(76==e.keyCode)var t="Quick Links";else if(70==e.keyCode)var t="Focus";else if(84==e.keyCode)var t="Todo";else if(83==e.keyCode)var t="Search";else if(188==e.keyCode)var t="Settings";else{if(67==e.keyCode){var t="Chrome Tab";return ga("send","event",t,"Hotkey"),void chrome.tabs.update({url:"chrome-search://local-ntp/local-ntp.html"})}32==e.keyCode&&m.trigger("globalEvent:spacebar")}t&&(m.trigger("globalEvent:toggle"+t.replace(/\s+/g,"")),ga("send","event",t,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.commandManager=new m.CommandManager,m.appView=new m.views.Dashboard,$(window).resize(function(){setMaxWidgetHeight()}),localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.addinManager=new m.models.AddinManager,m.syncCoordinator=new m.models.SyncCoordinator,window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),ga("create",m.globals.googleAnalyticsCode,"auto"),ga("set","checkProtocolTask",function(){}),ga("require","displayfeatures"),ga("send","pageview","/dashboard.html?v="+m.globals.version),submitStats("pageview"),m.syncCoordinator.syncSettings()}),function(e,t,n,i,o,s,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,s=t.createElement(n),a=t.getElementsByTagName(n)[0],s.async=1,s.src=i,a.parentNode.insertBefore(s,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga");